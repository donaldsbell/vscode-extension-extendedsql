name: VS Code ESQL Extension - Build and Release
on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"
jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22"

      - name: Install Visual Studio Code Extension Builder
        run: npm install -g @vscode/vsce

      - name: Package Extension
        run: |
          env |sort
          pwd
          ls -la
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            echo "Triggered by tag: ${TAG_NAME}"
            VERSION_FROM_TAG_NAME="${TAG_NAME#v}"
            vsce package --no-git-tag-version "${VERSION_FROM_TAG_NAME}"
          else
            BUILD_ID=${{ github.run_number }}
            VERSION=$(jq -r '.version' package.json)
            PRERELEASE_VERSION="${VERSION}-build${BUILD_ID}"
            jq --arg ver "$PRERELEASE_VERSION" '.version = $ver' package.json > tmp.json
            rm package.json
            mv tmp.json package.json

            vsce package --pre-release
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: esql-vscode-extension
          path: ./*.vsix
